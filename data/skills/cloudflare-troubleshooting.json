{
  "id": "cloudflare-troubleshooting",
  "name": "cloudflare-troubleshooting",
  "version": "1.0.0",
  "summary": "Investigate and resolve Cloudflare configuration issues using API-driven evidence gathering. Use when troubleshooting ERR_TOO_MANY_REDIRECTS, SSL errors, DNS issues, or any Clou...",
  "description": "# Cloudflare Troubleshooting\n\n## Core Principle\n\n**Investigate with evidence, not assumptions.** Always query Cloudflare API to examine actual configuration before diagnosing issues. The skill's value is the systematic investigation methodology, not predetermined solutions.\n\n## Investigation Methodology\n\n### 1. Gather Credentials\n\nRequest from user:\n- Domain name\n- Cloudflare account email\n- Cloudflare Global API Key (or API Token)\n\nGlobal API Key location: Cloudflare Dashboard → My Profile → API Tokens → View Global API Key\n\n### 2. Get Zone Information\n\nFirst step for any Cloudflare troubleshooting - obtain the zone ID:\n\n```bash\ncurl -s -X GET \"https://api.cloudflare.com/client/v4/zones?name=<domain>\" \\\n  -H \"X-Auth-Email: <email>\" \\\n  -H \"X-Auth-Key: <api_key>\" | jq '.'\n```\n\nExtract `zone_id` from `result[0].id` for subsequent API calls.\n\n### 3. Investigate Systematically\n\nFor each issue, gather evidence before making conclusions. Use Cloudflare API to inspect:\n- Current configuration state\n- Recent changes (if audit log available)\n- Related settings that might interact\n\n## Common Investigation Patterns\n\n### Redirect Loops (ERR_TOO_MANY_REDIRECTS)\n\n**Evidence gathering sequence:**\n\n1. **Check SSL/TLS mode:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/settings/ssl\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n   Look for: `result.value` - tells current SSL mode\n\n2. **Check Always Use HTTPS setting:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/settings/always_use_https\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n3. **Check Page Rules for redirects:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/pagerules\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n   Look for: `forwarding_url` or `always_use_https` actions\n\n4. **Test origin server directly (if possible):**\n   ```bash\n   curl -I -H \"Host: <domain>\" https://<origin_ip>\n   ```\n\n**Diagnosis logic:**\n- SSL mode \"flexible\" + origin enforces HTTPS = redirect loop\n- Multiple redirect rules can conflict\n- Check browser vs curl behavior differences\n\n**Fix:**\n```bash\ncurl -X PATCH \"https://api.cloudflare.com/client/v4/zones/{zone_id}/settings/ssl\" \\\n  -H \"X-Auth-Email: email\" \\\n  -H \"X-Auth-Key: key\" \\\n  -H \"Content-Type: application/json\" \\\n  --data '{\"value\":\"full\"}'\n```\n\nPurge cache after fix:\n```bash\ncurl -X POST \"https://api.cloudflare.com/client/v4/zones/{zone_id}/purge_cache\" \\\n  -H \"X-Auth-Email: email\" \\\n  -H \"X-Auth-Key: key\" \\\n  -d '{\"purge_everything\":true}'\n```\n\n### DNS Issues\n\n**Evidence gathering:**\n\n1. **List DNS records:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/dns_records\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n2. **Check external DNS resolution:**\n   ```bash\n   dig <domain>\n   dig @8.8.8.8 <domain>\n   ```\n\n3. **Check DNSSEC status:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/dnssec\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n**Look for:**\n- Missing A/AAAA/CNAME records\n- Incorrect proxy status (proxied vs DNS-only)\n- TTL values\n- Conflicting records\n\n### SSL Certificate Errors\n\n**Evidence gathering:**\n\n1. **Check SSL certificate status:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/ssl/certificate_packs\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n2. **Check origin certificate (if using Full Strict):**\n   ```bash\n   openssl s_client -connect <origin_ip>:443 -servername <domain>\n   ```\n\n3. **Check SSL settings:**\n   - Minimum TLS version\n   - TLS 1.3 status\n   - Opportunistic Encryption\n\n**Common issues:**\n- Error 526: SSL mode is \"strict\" but origin cert invalid\n- Error 525: SSL handshake failure at origin\n- Provisioning delay: Wait 15-30 minutes for Universal SSL\n\n### Origin Server Errors (502/503/504)\n\n**Evidence gathering:**\n\n1. **Check if origin is reachable:**\n   ```bash\n   curl -I -H \"Host: <domain>\" https://<origin_ip>\n   ```\n\n2. **Check DNS records point to correct origin:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/dns_records\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n3. **Review load balancer config (if applicable):**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/load_balancers\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n4. **Check firewall rules:**\n   ```bash\n   curl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/firewall/rules\" \\\n     -H \"X-Auth-Email: email\" \\\n     -H \"X-Auth-Key: key\"\n   ```\n\n## Learning New APIs\n\nWhen encountering issues not covered above, consult Cloudflare API documentation:\n\n1. **Browse API reference:** https://developers.cloudflare.com/api/\n2. **Search for relevant endpoints** using issue keywords\n3. **Check API schema** to understand available operations\n4. **Test with GET requests** first to understand data structure\n5. **Make changes with PATCH/POST** after confirming approach\n\n**Pattern for exploring new APIs:**\n```bash\n# List available settings for a zone\ncurl -X GET \"https://api.cloudflare.com/client/v4/zones/{zone_id}/settings\" \\\n  -H \"X-Auth-Email: email\" \\\n  -H \"X-Auth-Key: key\"\n```\n\n## API Reference Overview\n\nConsult `references/api_overview.md` for:\n- Common endpoints organized by category\n- Request/response schemas\n- Authentication patterns\n- Rate limits and error handling\n\nConsult `references/ssl_modes.md` for:\n- Detailed SSL/TLS mode explanations\n- Platform compatibility\n- Security implications\n\nConsult `references/common_issues.md` for:\n- Issue patterns and symptoms\n- Investigation checklists\n- Platform-specific notes\n\n## Best Practices\n\n### Evidence-Based Investigation\n\n1. **Query before assuming** - Use API to check actual state\n2. **Gather multiple data points** - Cross-reference settings\n3. **Check related configurations** - Settings often interact\n4. **Verify externally** - Use dig/curl to confirm\n5. **Test incrementally** - One change at a time\n\n### API Usage\n\n1. **Parse JSON responses** - Use `jq` or python for readability\n2. **Check success field** - `\"success\": true/false` in responses\n3. **Handle errors gracefully** - Read `errors` array in responses\n4. **Respect rate limits** - Cloudflare API has limits\n5. **Use appropriate methods:**\n   - GET: Retrieve information\n   - PATCH: Update settings\n   - POST: Create resources / trigger actions\n   - DELETE: Remove resources\n\n### Making Changes\n\n1. **Gather evidence first** - Understand current state\n2. **Identify root cause** - Don't guess\n3. **Apply targeted fix** - Change only what's needed\n4. **Purge cache if needed** - Especially for SSL/redirect changes\n5. **Verify fix** - Re-query API to confirm\n6. **Inform user of wait times:**\n   - Edge server propagation: 30-60 seconds\n   - DNS propagation: Up to 48 hours\n   - Browser cache: Requires manual clear\n\n### Security\n\n- Never log API keys in output\n- Warn if user shares credentials in public context\n- Recommend API Tokens with scoped permissions over Global API Key\n- Use read-only operations for investigation\n\n## Workflow Template\n\n```\n1. Gather: domain, email, API key\n2. Get zone_id via zones API\n3. Investigate:\n   - Query relevant APIs for evidence\n   - Check multiple related settings\n   - Verify with external tools (dig, curl)\n4. Analyze evidence to determine root cause\n5. Apply fix via appropriate API endpoint\n6. Purge cache if configuration change affects delivery\n7. Verify fix via API query and external testing\n8. Inform user of resolution and any required actions\n```\n\n## Example: Complete Investigation\n\nWhen user reports \"site shows ERR_TOO_MANY_REDIRECTS\":\n\n```bash\n# 1. Get zone ID\ncurl -s -X GET \"https://api.cloudflare.com/client/v4/zones?name=example.com\" \\\n  -H \"X-Auth-Email: user@example.com\" \\\n  -H \"X-Auth-Key: abc123\" | jq '.result[0].id'\n\n# 2. Check SSL mode (primary suspect for redirect loops)\ncurl -s -X GET \"https://api.cloudflare.com/client/v4/zones/ZONE_ID/settings/ssl\" \\\n  -H \"X-Auth-Email: user@example.com\" \\\n  -H \"X-Auth-Key: abc123\" | jq '.result.value'\n\n# If returns \"flexible\" and origin is GitHub Pages/Netlify/Vercel:\n\n# 3. Fix by changing to \"full\"\ncurl -X PATCH \"https://api.cloudflare.com/client/v4/zones/ZONE_ID/settings/ssl\" \\\n  -H \"X-Auth-Email: user@example.com\" \\\n  -H \"X-Auth-Key: abc123\" \\\n  -H \"Content-Type: application/json\" \\\n  --data '{\"value\":\"full\"}'\n\n# 4. Purge cache\ncurl -X POST \"https://api.cloudflare.com/client/v4/zones/ZONE_ID/purge_cache\" \\\n  -H \"X-Auth-Email: user@example.com\" \\\n  -H \"X-Auth-Key: abc123\" \\\n  -d '{\"purge_everything\":true}'\n\n# 5. Inform user: Wait 60 seconds, clear browser cache, retry\n```\n\n## When Scripts Are Useful\n\nThe bundled scripts (`scripts/check_cloudflare_config.py`, `scripts/fix_ssl_mode.py`) serve as:\n- **Reference implementations** of investigation patterns\n- **Quick diagnostic tools** when Python is available\n- **Examples** of programmatic API usage\n\nHowever, **prefer direct API calls via Bash/curl** for flexibility and transparency. Scripts should not limit capability - use them when convenient, but use raw API calls when needed for:\n- Unfamiliar scenarios\n- Edge cases\n- Learning/debugging\n- Operations not covered by scripts\n\nThe investigation methodology and API knowledge is the core skill, not the scripts.",
  "verticals": [
    "engineering"
  ],
  "tags": [],
  "author": {
    "name": "daymade",
    "github": "daymade"
  },
  "status": "ready",
  "verified": false,
  "visibility": "public",
  "license": "MIT",
  "links": {
    "repo": "https://github.com/daymade/claude-code-skills",
    "skill_md": "https://raw.githubusercontent.com/daymade/claude-code-skills/main/cloudflare-troubleshooting/SKILL.md"
  },
  "stats": {
    "stars": 154,
    "forks": 13,
    "installs": 0
  },
  "last_updated": "2026-01-07T15:30:48Z",
  "created_at": "2025-10-22T11:17:31Z",
  "meta": {
    "source": "github",
    "sourceUrl": "https://github.com/daymade/claude-code-skills/blob/main/cloudflare-troubleshooting/SKILL.md",
    "harvestedAt": "2026-01-07T16:59:54.890Z",
    "uniqueId": "sk_1ce4b80e4c06"
  }
}